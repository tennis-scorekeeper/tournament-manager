<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Welcome to Firebase Hosting</title>

    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
      integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T"
      crossorigin="anonymous"
    />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
    <script
      src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
      crossorigin="anonymous"
    ></script>
    <!-- update the version number as needed -->
    <script defer src="/__/firebase/6.0.4/firebase-app.js"></script>
    <!-- include only the Firebase features as you need -->
    <script defer src="/__/firebase/6.0.4/firebase-auth.js"></script>
    <script defer src="/__/firebase/6.0.4/firebase-database.js"></script>
    <!-- initialize the SDK after all desired features are loaded -->
    <script defer src="/__/firebase/init.js"></script>
  </head>
  <body>
    <div id="bracketNameHolder">
      <h2 id="drawName"></h2>
    </div>
    <button id="saveButton" type="button" class="btn btn-primary" onclick="saveDraw()">Save</button>
    <p id="savingProgress"></p>
    <div id="bracket">
      <img height="1000" width="1750" id="bracket" src="images/16b.png">

      <select id="m0a" onchange="saveDraw2('m0', 'm0a')">
          <option>Bye</option>
      </select>
      <select id="m0b" onchange="saveDraw2('m0', 'm0b')">
          <option>Bye</option>
      </select>
      <button id="m0" class="editMatch" onclick="editMatch('m0')" data-toggle="modal" data-target="#editMatchModal"></button>

      <select id="m1a" onchange="saveDraw2('m1', 'm1a')">
          <option>Bye</option>
      </select>
      <select id="m1b" onchange="saveDraw2('m1', 'm1b')">
          <option>Bye</option>
      </select>
      <button id="m1" class="editMatch" onclick="editMatch('m1')" data-toggle="modal" data-target="#editMatchModal"></button>

      <select id="m2a" onchange="saveDraw2('m2', 'm2a')">
          <option>Bye</option>
      </select>
      <select id="m2b" onchange="saveDraw2('m2', 'm2b')">
          <option>Bye</option>
      </select>
      <button id="m2" class="editMatch" onclick="editMatch('m2')" data-toggle="modal" data-target="#editMatchModal"></button>

      <select id="m3a" onchange="saveDraw2('m3', 'm3a')">
          <option>Bye</option>
      </select>
      <select id="m3b" onchange="saveDraw2('m3', 'm3b')">
          <option>Bye</option>
      </select>
      <button id="m3" class="editMatch" onclick="editMatch('m3')" data-toggle="modal" data-target="#editMatchModal"></button>

      <select id="m4a" onchange="saveDraw2('m4', 'm4a')">
          <option>Bye</option>
      </select>
      <select id="m4b" onchange="saveDraw2('m4', 'm4b')">
          <option>Bye</option>
      </select>
      <button id="m4" class="editMatch" onclick="editMatch('m4')" data-toggle="modal" data-target="#editMatchModal"></button>

      <select id="m5a" onchange="saveDraw2('m5', 'm5a')">
          <option>Bye</option>
      </select>
      <select id="m5b" onchange="saveDraw2('m5', 'm5b')">
          <option>Bye</option>
      </select>
      <button id="m5" class="editMatch" onclick="editMatch('m5')" data-toggle="modal" data-target="#editMatchModal"></button>

      <select id="m6a" onchange="saveDraw2('m6', 'm6a')">
          <option>Bye</option>
      </select>
      <select id="m6b" onchange="saveDraw2('m6', 'm6b')">
          <option>Bye</option>
      </select>
      <button id="m6" class="editMatch" onclick="editMatch('m6')" data-toggle="modal" data-target="#editMatchModal"></button>

      <select id="m7a" onchange="saveDraw2('m7', 'm7a')">
          <option>Bye</option>
      </select>
      <select id="m7b" onchange="saveDraw2('m7', 'm7b')">
          <option>Bye</option>
      </select>
      <button id="m7" class="editMatch" onclick="editMatch('m7')" data-toggle="modal" data-target="#editMatchModal"></button>

      <span id="m8a"></span>
      <span id="m8b"></span>
      <button id="m8" class="editMatch" onclick="editMatch('m8')" data-toggle="modal" data-target="#editMatchModal"></button>

      <span id="m9a"></span>
      <span id="m9b"></span>
      <button id="m9" class="editMatch" onclick="editMatch('m9')" data-toggle="modal" data-target="#editMatchModal"></button>

      <span id="m10a"></span>
      <span id="m10b"></span>
      <button id="m10" class="editMatch" onclick="editMatch('m10')" data-toggle="modal" data-target="#editMatchModal"></button>

      <span id="m11a"></span>
      <span id="m11b"></span>
      <button id="m11" class="editMatch" onclick="editMatch('m11')" data-toggle="modal" data-target="#editMatchModal"></button>

      <span id="m12a"></span>
      <span id="m12b"></span>
      <button id="m12" class="editMatch" onclick="editMatch('m12')" data-toggle="modal" data-target="#editMatchModal"></button>

      <span id="m13a"></span>
      <span id="m13b"></span>
      <button id="m13" class="editMatch" onclick="editMatch('m13')" data-toggle="modal" data-target="#editMatchModal"></button>

      <span id="m14a"></span>
      <span id="m14b"></span>
      <button id="m14" class="editMatch" onclick="editMatch('m14')" data-toggle="modal" data-target="#editMatchModal"></button>

      <span id="winner"></span>
    </div>

    <div class="modal fade" id="editMatchModal" tabindex="-1" role="dialog" aria-labelledby="editMatchModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="editMatchModalLabel">
            Edit Match
          </h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div id="editMatchDateHolder">
            <input type="date" id="editMatchDate" />
          </div>
          <div class="row">
            <div class="col-5">
              
              <input id="p1" type="radio" name="matchWinner">
              <label id="p1Label" class="matchWinner" for="p1">Player 1</label><br>
              <input id="p2" type="radio" name="matchWinner">
              <label id="p2Label" class="matchWinner" for="p2">Player 2</label><br>
            </div>
            <div class="col-7">
              <div>
                <input id="p1s1" class="scoreInput" type="number"/>
                <input id="p1s2" class="scoreInput" type="number"/>
                <input id="p1s3" class="scoreInput" type="number"/>
              </div>
              <div>
                  <input id="p2s1" class="scoreInput" type="number"/>
                  <input id="p2s2" class="scoreInput" type="number"/>
                  <input id="p2s3" class="scoreInput" type="number"/>
                </div>
            </div>
          </div>
          <div style="text-align: center">
            <label for="matchCourtNumber">Court</label>
            <input type="number" id="matchCourtNumber"/>
            <label for="matchTime">Time</label>
            <input type="time" id="matchTime" />
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            Close
          </button>
          <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="saveMatch()">
              Save
            </button>
        </div>
      </div>
    </div>
  </div>
  </body>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      try {
        firebase.auth().onAuthStateChanged(function (user) {
          if (user) {
            loadDraw();
          } else {
            window.location.replace("/");
          }
        });
      } catch (e) {
        console.error(e);
      }
    });

    function loadDraw() {
      var url = window.location.href.substring(
        window.location.href.indexOf("?")
      );
      var params = new URLSearchParams(url);
      var tournamentId = params.get("tournamentId");
      var divName = params.get("div");
      document.getElementById("drawName").textContent = divName;

      var rootRef = firebase.database().ref();
      var tournamentsRef = rootRef.child("tournaments");
      var divRef = tournamentsRef.child(tournamentId).child("divisions").child(divName);

      var fullMatchIds = ["m0", "m1", "m2","m3", 
                      "m4", "m5", "m6", "m7"]

      var fullMatchIds2 = ["m8", "m9", "m10","m11", 
                      "m12", "m13", "m14"]

      var matchIds = ["m0a", "m0b", "m1a", "m1b", "m2a", "m2b", "m3a", "m3b",
                      "m4a", "m4b", "m5a", "m5b", "m6a", "m6b", "m7a", "m7b"]

      var playerOptionElements = [];
      divRef.once("value").then(ss => {
        var playersList = ss.child("players").val();

        matchIds.forEach(id => {
          playersList.forEach(player => {
            var optionElement = document.createElement("option");
            optionElement.textContent = player;
            optionElement.setAttribute("value", player);
            document.getElementById(id).appendChild(optionElement);
          })
        })
        fullMatchIds.forEach(id => {
          document.getElementById(id+"a").value = ss.child("draw").child(id).child(id+"a").val();
          document.getElementById(id+"b").value = ss.child("draw").child(id).child(id+"b").val();
        })
        fullMatchIds2.forEach(id => {
          document.getElementById(id+"a").textContent = ss.child("draw").child(id).child(id+"a").val();
          document.getElementById(id+"b").textContent = ss.child("draw").child(id).child(id+"b").val();
        })
        document.getElementById("winner").textContent = ss.child("draw").child("winner").val();
      })
    }

    function saveDraw2(matchId, matchPlayerId) {
      document.getElementById("savingProgress").textContent = "Saving..."
      var url = window.location.href.substring(
        window.location.href.indexOf("?")
      );
      var params = new URLSearchParams(url);
      var tournamentId = params.get("tournamentId");
      var divName = params.get("div");
      document.getElementById("drawName").textContent = divName;

      var rootRef = firebase.database().ref();
      var tournamentsRef = rootRef.child("tournaments");
      var divRef = tournamentsRef.child(tournamentId).child("divisions").child(divName);
      var matchNumber = parseInt(matchId.substring(1));

      if (matchNumber < 8) {
        divRef.child("draw").child(matchId).child(matchPlayerId).set(document.getElementById(matchPlayerId).value).then(tmp => {
          document.getElementById("savingProgress").textContent = "Saved!"
        });
      } else {
        divRef.child("draw").child(matchId).child(matchPlayerId).set(document.getElementById(matchPlayerId).textContent).then(tmp => {
          document.getElementById("savingProgress").textContent = "Saved!"
        });
      }
    }

    function saveDraw() {
      document.getElementById("savingProgress").textContent = "Saving..."
      var url = window.location.href.substring(
        window.location.href.indexOf("?")
      );
      var params = new URLSearchParams(url);
      var tournamentId = params.get("tournamentId");
      var divName = params.get("div");
      document.getElementById("drawName").textContent = divName;

      var rootRef = firebase.database().ref();
      var tournamentsRef = rootRef.child("tournaments");
      var divRef = tournamentsRef.child(tournamentId).child("divisions").child(divName);

      var fullMatchIds = ["m0", "m1", "m2","m3", 
                        "m4", "m5", "m6", "m7"]

      var fullMatchIds2 = ["m8", "m9", "m10","m11", 
                        "m12", "m13", "m14"]

      fullMatchIds.forEach(id => {
        divRef.child("draw").child(id).child(id+"a").set(document.getElementById(id+"a").value);
        divRef.child("draw").child(id).child(id+"b").set(document.getElementById(id+"b").value);
      })
      fullMatchIds2.forEach(id => {
        divRef.child("draw").child(id).child(id+"a").set(document.getElementById(id+"a").textContent);
        divRef.child("draw").child(id).child(id+"b").set(document.getElementById(id+"b").textContent);
      })
      divRef.child("draw").child("winner").set(document.getElementById("winner").textContent);
        
      document.getElementById("savingProgress").textContent = "Saved!"
    }

    function editMatch(matchId) {
      var matchNumber = parseInt(matchId.substring(1));
      document.getElementById("editMatchModalLabel").textContent = matchId;

      if (matchNumber < 8) {
        document.getElementById("p1Label").textContent = document.getElementById(matchId+"a").value
        document.getElementById("p2Label").textContent = document.getElementById(matchId+"b").value
      } else {
        document.getElementById("p1Label").textContent = document.getElementById(matchId+"a").textContent
        document.getElementById("p2Label").textContent = document.getElementById(matchId+"b").textContent
      }
    }

    function saveMatch() {
      var url = window.location.href.substring(
        window.location.href.indexOf("?")
      );
      var params = new URLSearchParams(url);
      var tournamentId = params.get("tournamentId");
      var divName = params.get("div");
      document.getElementById("drawName").textContent = divName;

      var rootRef = firebase.database().ref();
      var tournamentsRef = rootRef.child("tournaments");
      var divRef = tournamentsRef.child(tournamentId).child("divisions").child(divName);

      var matchId = document.getElementById("editMatchModalLabel").textContent;
      var winner = "";
      if (document.getElementById("p1").checked) {
        winner = document.getElementById("p1Label").textContent;
      }
      if (document.getElementById("p2").checked) {
        winner = document.getElementById("p2Label").textContent;
      }

      var score = document.getElementById("p1s1").value + "-" + document.getElementById("p2s1").value + " " 
        + document.getElementById("p1s2").value + "-" + document.getElementById("p2s2").value + " "
        + document.getElementById("p1s3").value + "-" + document.getElementById("p2s3").value;


      divRef.child("draw").child(matchId).update({
        "winner": winner,
        "score": score,
        "date": document.getElementById("editMatchDate").value,
        "courtNumber": document.getElementById("matchCourtNumber").value,
        "matchTime": document.getElementById("matchTime").value  
      })

      var matchProgressionList = ["m8a","m8b","m9a","m9b","m10a","m10b","m11a","m11b","m12a","m12b","m13a","m13b","m14a","m14b","winner"];
      document.getElementById(matchProgressionList[parseInt(matchId.substring(1))]).textContent = winner;

      saveDraw();

    }
  </script>

  <style>
    #bracketNameHolder {
      margin-top:20px;
      text-align:center;
    }

    #bracket {
      position: absolute;
      top:50px;
    }

    #saveButton {
      position: absolute;
      top: 20px;
      left: 20px;
    }

    #savingProgress {
      position: absolute;
      top: 25px;
      left: 90px;
    }

    .editMatch {
      background-color: #cfe2f3;
      border: 1px solid black;
    }

    #editMatchDateHolder {
      text-align: right;
    }

    .scoreInput {
      width: 2em;
      height: 2.2em;
      font-size:25px;
      margin-top: 15px;
    }

    .matchWinner {
      margin-top: 20px;
      font-size: 25px;
    }

    #matchCourtNumber {
      margin-top: 20px;
      width: 2em;
      margin-right: 50px;
    }

    #matchTime {
      margin-top: 20px;
      width: 5em;
    }

    #m0a {
      position: absolute;
      left: 50px;
      top: 70px;
    }
    #m0b {
      position: absolute;
      left: 50px;
      top: 199px;
    }
    #m0 {
      position: absolute;
      left: 190px;
      top: 154px;
      padding: 7px;
    }

    #m1a {
      position: absolute;
      left: 50px;
      top: 328px;
    }
    #m1b {
      position: absolute;
      left: 50px;
      top: 457px;
    }
    #m1 {
      position: absolute;
      left: 190px;
      top: 412px;
      padding: 7px;
    }

    #m2a {
      position: absolute;
      left: 50px;
      top: 586px;
    } 
    #m2b {
      position: absolute;
      left: 50px;
      top: 715px;
    }
    #m2 {
      position: absolute;
      left: 190px;
      top: 670px;
      padding: 7px;
    }

    #m3a {
      position: absolute;
      left: 50px;
      top: 844px;
    }
    #m3b {
      position: absolute;
      left: 50px;
      top: 973px;
    }
    #m3 {
      position: absolute;
      left: 190px;
      top: 928px;
      padding: 7px;
    }

    #m4a {
      position: absolute;
      left: 1550px;
      top: 70px;
    }
    #m4b {
      position: absolute;
      left: 1550px;
      top: 199px;
    }
    #m4 {
      position: absolute;
      left: 1550px;
      top: 154px;
      padding: 7px;
    }

    #m5a {
      position: absolute;
      left: 1550px;
      top: 328px;
    }
    #m5b {
      position: absolute;
      left: 1550px;
      top: 457px;
    }
    #m5 {
      position: absolute;
      left: 1550px;
      top: 412px;
      padding: 7px;
    }

    #m6a {
      position: absolute;
      left: 1550px;
      top: 586px;
    }
    #m6b {
      position: absolute;
      left: 1550px;
      top: 715px;
    }
    #m6 {
      position: absolute;
      left: 1550px;
      top: 670px;
      padding: 7px;
    }

    #m7a {
      position: absolute;
      left: 1550px;
      top: 844px;
    }
    #m7b {
      position: absolute;
      left: 1550px;
      top: 973px;
    }
    #m7 {
      position: absolute;
      left: 1550px;
      top: 928px;
      padding: 7px;
    }

    #m8a {
      position: absolute;
      left: 250px;
      top: 134px;
    }
    #m8b {
      position: absolute;
      left: 250px;
      top: 392px;
    }
    #m8 {
      position: absolute;
      left: 375px;
      top: 281px;
      padding: 7px;
    }

    #m9a {
      position: absolute;
      left: 250px;
      top: 650px;
    }
    #m9b {
      position: absolute;
      left: 250px;
      top: 908px;
    }
    #m9 {
      position: absolute;
      left: 375px;
      top: 797px;
      padding: 7px;
    }

    #m10a {
      position: absolute;
      left: 1370px;
      top: 134px;
    }
    #m10b {
      position: absolute;
      left: 1370px;
      top: 392px;
    }
    #m10 {
      position: absolute;
      left: 1360px;
      top: 281px;
      padding: 7px;
    }
    

    #m11a {
      position: absolute;
      left: 1360px;
      top: 650px;
    }
    #m11b {
      position: absolute;
      left: 1370px;
      top: 908px;
    }
    #m11 {
      position: absolute;
      left: 1370px;
      top: 797px;
      padding: 7px;
    }

    #m12a {
      position: absolute;
      left: 440px;
      top: 263px;
    }
    #m12b {
      position: absolute;
      left: 440px;
      top: 779px;
    }
    #m12 {
      position: absolute;
      left: 560px;
      top: 540px;
      padding: 7px;
    }

    #m13a {
      position: absolute;
      left: 1190px;
      top: 263px;
    }
    #m13b {
      position: absolute;
      left: 1190px;
      top: 779px;
    }
    #m13 {
      position: absolute;
      left: 1175px;
      top: 540px;
      padding: 7px;
    }

    #m14a {
      position: absolute;
      left: 630px;
      top: 521px;
    }
    #m14b {
      position: absolute;
      left: 1000px;
      top: 521px;
    }
    #m14 {
      position: absolute;
      left: 865px;
      top: 540px;
      padding: 7px;
    }

    #winner {
      position: absolute;
      left: 800px;
      top: 650px;
    }
  </style>
</html>
